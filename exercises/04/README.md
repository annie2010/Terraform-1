# Exercise #4: How to Query the State

* terraform's state is the way in which it is able to keep track infrastructure configuration 
* state is used to store information that is generated by the actual resulting infrastructure
  * an example of this would be EC2 instances, where the essential config is stored in the tf configuration files, but the instance ID has to be generated by AWS
  * after AWS generates this ID, terraform records this information in the state

* there are many reasons why you would want to query a state for information, either via CLI or using terraform's interpolation
  * we will experiment with three ways this can be done

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

### Launch Infrastructure

```bash
terraform init
terraform apply
```

* (Have you saved yourself from having to worry about your student alias as a variable again yet?)

### Command Line

* terraform has a CLI command "show", which allows users to export useful information from the state in a way 
that can be easily `grep`ed or `awk`ed

```bash
terraform show
```

You should see something like this below:

```
# aws_s3_bucket_object.user_student_alias_object: 
resource "aws_s3_bucket_object" "user_student_alias_object" {
    acl           = "private"
    bucket        = "devint-..."
    content       = "This bucket is reserved for ..."
    content_type  = "binary/octet-stream"
    etag          = "94e32327b8007fa215f3a9edbda7f68c"
    id            = "student.alias"
    key           = "student.alias"
    storage_class = "STANDARD"
}

# data.terraform_remote_state.other_project: 
data "terraform_remote_state" "other_project" {
    backend   = "local"
    config    = {
        path = "other_project/terraform.tfstate"
    }
    outputs   = {
        bucket_name = "blep-20190110063357193700000001"
    }
    workspace = "default"
}


Outputs:

other_project_bucket = "blep-20190110063357193700000001"
```

* maybe even more helpful, terraform also supports outputting state in a more machine-readable way:

```bash
terraform show -json
```

* terraform stores state as JSON, so this is mostly just returning a very similar structure and set of values that you 
might find in your `terraform.tfstate` file as well, assuming you're using local state

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

### Remote State Data Type

* state isn't always stored in a local file
  * if you have another project's state file accessible, you can use the `remote_state` data type to parse remote state with interpolation like everything else     
 
* in this directory, there is a folder called `other_project`
  * that folder contains a terraform project that has already generated resources
  * therefore it has a populated `tfstate` file for us to reference
  * if you run the following in the current directory, you'll get an output from the statefile in `other_project`, not the bucket created by this project

```bash
terraform output other_project_bucket
```

* if you saw "blep-20190110063357193700000001" then this worked successfully
  * take some time you look at the usage of the `remote_state` data resource and how it's implemented in this exercise and play around with it a bit
  * are you able to create another project and get outputs from that project?

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

&nbsp;

### Direct JSON Parse

* since the `tfstate` files are just JSON files, given the appropriate level of motivation, you could parse it directly to
get the info you need
  * this isn't really a feature of terraform, but rather a side-effect of the way state files exist, so we won't be doing that in this exercise

### Finishing this exercise

* let's run the following to finish:

```bash
terraform destroy
```
